<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 1: Scalability - Staff Engineer Prep</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        /* Interactive Load Balancer Demo */
        .lb-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 1rem;
            padding: 2rem;
            margin: 1.5rem 0;
        }

        .lb-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .lb-algo-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
        }

        .lb-algo-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.2);
        }

        .lb-algo-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .lb-visualization {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem 0;
            position: relative;
            min-height: 300px;
        }

        .lb-clients {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .lb-client {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
            transition: all 0.3s ease;
        }

        .lb-client.sending {
            animation: pulse-send 0.5s ease;
        }

        @keyframes pulse-send {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); box-shadow: 0 10px 30px rgba(17, 153, 142, 0.6); }
        }

        .lb-balancer {
            width: 120px;
            height: 120px;
            border-radius: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            position: relative;
            z-index: 10;
        }

        .lb-balancer .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .lb-servers {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .lb-server {
            width: 100px;
            height: 80px;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .lb-server .icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .lb-server .load-bar {
            position: absolute;
            bottom: 5px;
            left: 10px;
            right: 10px;
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .lb-server .load-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .lb-server.receiving {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(237, 137, 54, 0.4);
        }

        .lb-server.overloaded .load-fill {
            background: linear-gradient(90deg, #f56565, #e53e3e);
        }

        .request-packet {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
            z-index: 5;
            pointer-events: none;
        }

        .lb-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .lb-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            color: white;
            min-width: 120px;
        }

        .lb-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffd700;
        }

        .lb-stat-label {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-top: 0.25rem;
        }

        .lb-explanation {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            color: white;
            margin-top: 1.5rem;
            text-align: center;
        }

        /* Cache Animation Demo */
        .cache-container {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border-radius: 1rem;
            padding: 2rem;
            margin: 1.5rem 0;
        }

        .cache-visualization {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
            margin: 1.5rem 0;
        }

        .cache-component {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .cache-box {
            width: 120px;
            height: 100px;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cache-box.app {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .cache-box.cache {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
        }

        .cache-box.db {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .cache-box.active {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .cache-box .icon {
            font-size: 2rem;
            margin-bottom: 0.25rem;
        }

        .cache-arrow {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .cache-arrow.active {
            background: linear-gradient(90deg, #ffd700, #ff8c00);
        }

        .cache-arrow::after {
            content: '‚Üí';
            position: absolute;
            right: -10px;
            top: -10px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.2rem;
        }

        .cache-arrow.active::after {
            color: #ffd700;
        }

        .cache-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .cache-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }

        .cache-btn.hit {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .cache-btn.miss {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .cache-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .cache-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 120px;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .cache-log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cache-log-entry.hit {
            color: #48bb78;
        }

        .cache-log-entry.miss {
            color: #f56565;
        }

        .cache-stats {
            display: flex;
            gap: 2rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .cache-stat {
            text-align: center;
            color: white;
        }

        .cache-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .cache-stat-value.hit-rate {
            color: #48bb78;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">StaffEngPrep</a>
            <ul class="nav-links">
                <li><a href="../coding-rounds/index.html">Coding</a></li>
                <li><a href="index.html" style="color: var(--primary-color);">System Design</a></li>
                <li><a href="../company-specific/index.html">Companies</a></li>
                <li><a href="../behavioral/index.html">Behavioral</a></li>
                <li><a href="../generative-ai/index.html">Gen AI</a></li>
            </ul>
        </div>
    </nav>

    <div class="layout-with-sidebar">
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Getting Started</div>
                    <a href="index.html" class="sidebar-link">Introduction</a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Core Concepts</div>
                    <a href="module-01.html" class="sidebar-link active" data-module="1">
                        <span class="sidebar-link-number">1</span>Scalability Fundamentals
                    </a>
                    <a href="module-02.html" class="sidebar-link" data-module="2">
                        <span class="sidebar-link-number">2</span>Database Systems
                    </a>
                    <a href="module-03.html" class="sidebar-link" data-module="3">
                        <span class="sidebar-link-number">3</span>Distributed Systems
                    </a>
                    <a href="module-04.html" class="sidebar-link" data-module="4">
                        <span class="sidebar-link-number">4</span>Storage & Data Processing
                    </a>
                    <a href="module-05.html" class="sidebar-link" data-module="5">
                        <span class="sidebar-link-number">5</span>Seminal Papers
                    </a>
                    <a href="module-09.html" class="sidebar-link" data-module="9">
                        <span class="sidebar-link-number">6</span>API Design
                    </a>
                    <a href="module-10.html" class="sidebar-link" data-module="10">
                        <span class="sidebar-link-number">7</span>Numbers to Know
                    </a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Patterns</div>
                    <a href="module-11.html" class="sidebar-link" data-module="11">
                        <span class="sidebar-link-number">8</span>Real-time Updates
                    </a>
                    <a href="module-12.html" class="sidebar-link" data-module="12">
                        <span class="sidebar-link-number">9</span>Rate Limiting
                    </a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Problem Breakdowns</div>
                    <a href="module-06.html" class="sidebar-link" data-module="6">
                        <span class="sidebar-link-number">10</span>Common Problems
                    </a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Interview Prep</div>
                    <a href="module-07.html" class="sidebar-link" data-module="7">
                        <span class="sidebar-link-number">11</span>Framework Mastery
                    </a>
                    <a href="module-08.html" class="sidebar-link" data-module="8">
                        <span class="sidebar-link-number">12</span>Mock Interviews
                    </a>
                </div>
            </nav>
        </aside>

        <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <main class="main-content">
            <h1>Module 1: Scalability Fundamentals</h1>

            <div class="card mt-3">
                <h3>Learning Objectives</h3>
                <ul>
                    <li>Understand vertical vs horizontal scaling trade-offs</li>
                    <li>Learn load balancing strategies and algorithms</li>
                    <li>Master caching patterns and eviction policies</li>
                    <li>Apply CDN and edge computing concepts</li>
                </ul>
            </div>

            <h2 class="mt-4">Scaling Strategies</h2>

            <div class="collapsible open">
                <div class="collapsible-header">
                    <span>Vertical vs Horizontal Scaling</span>
                    <span class="collapsible-icon">&#9660;</span>
                </div>
                <div class="collapsible-content">
                    <div class="diagram-container">
                        <div class="mermaid">
flowchart LR
    subgraph "Vertical (Scale Up)"
        V1[Small Server] --> V2[Bigger Server]
        V2 --> V3[Biggest Server]
    end

    subgraph "Horizontal (Scale Out)"
        H1[Server] --> H2[+ Server]
        H2 --> H3[+ Server]
        H3 --> H4[+ Server]
    end
                        </div>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
                        <thead>
                            <tr style="background: var(--border-color);">
                                <th style="padding: 0.75rem; border: 1px solid var(--border-color);">Aspect</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border-color);">Vertical</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border-color);">Horizontal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Complexity</td><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Simple</td><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Complex (distributed)</td></tr>
                            <tr><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Limits</td><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Hardware ceiling</td><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Theoretically unlimited</td></tr>
                            <tr><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Downtime</td><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Required for upgrade</td><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Zero downtime possible</td></tr>
                            <tr><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Fault Tolerance</td><td style="padding: 0.75rem; border: 1px solid var(--border-color);">SPOF risk</td><td style="padding: 0.75rem; border: 1px solid var(--border-color);">Built-in redundancy</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <h2 class="mt-4">Load Balancing</h2>

            <!-- Interactive Load Balancer Demo -->
            <div class="collapsible open">
                <div class="collapsible-header">
                    <span>üéÆ Interactive Load Balancer Demo</span>
                    <span class="collapsible-icon">&#9660;</span>
                </div>
                <div class="collapsible-content">
                    <p class="text-muted">Select an algorithm and watch how requests are distributed across servers. Notice the different distribution patterns.</p>

                    <div class="lb-container" id="lb-demo">
                        <div class="lb-controls">
                            <button class="lb-algo-btn active" onclick="setLbAlgorithm('round-robin')">Round Robin</button>
                            <button class="lb-algo-btn" onclick="setLbAlgorithm('weighted')">Weighted</button>
                            <button class="lb-algo-btn" onclick="setLbAlgorithm('least-conn')">Least Connections</button>
                            <button class="lb-algo-btn" onclick="setLbAlgorithm('random')">Random</button>
                        </div>

                        <div class="lb-visualization" id="lb-viz">
                            <div class="lb-clients">
                                <div class="lb-client" id="client-1">üë§</div>
                                <div class="lb-client" id="client-2">üë§</div>
                                <div class="lb-client" id="client-3">üë§</div>
                            </div>

                            <div class="lb-balancer">
                                <span class="icon">‚öñÔ∏è</span>
                                <span>Load Balancer</span>
                            </div>

                            <div class="lb-servers">
                                <div class="lb-server" id="server-1" data-weight="3" data-connections="0">
                                    <span class="icon">üñ•Ô∏è</span>
                                    <span>Server 1</span>
                                    <span class="weight-label" style="font-size: 0.7rem; color: #a0aec0;">w:3</span>
                                    <div class="load-bar"><div class="load-fill" style="width: 20%"></div></div>
                                </div>
                                <div class="lb-server" id="server-2" data-weight="2" data-connections="0">
                                    <span class="icon">üñ•Ô∏è</span>
                                    <span>Server 2</span>
                                    <span class="weight-label" style="font-size: 0.7rem; color: #a0aec0;">w:2</span>
                                    <div class="load-bar"><div class="load-fill" style="width: 40%"></div></div>
                                </div>
                                <div class="lb-server" id="server-3" data-weight="1" data-connections="0">
                                    <span class="icon">üñ•Ô∏è</span>
                                    <span>Server 3</span>
                                    <span class="weight-label" style="font-size: 0.7rem; color: #a0aec0;">w:1</span>
                                    <div class="load-bar"><div class="load-fill" style="width: 70%"></div></div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-bottom: 1rem;">
                            <button class="lb-algo-btn" onclick="sendRequest()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                                üì§ Send Request
                            </button>
                            <button class="lb-algo-btn" onclick="autoSendRequests()" id="auto-send-btn" style="background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);">
                                üîÑ Auto Send (5 req)
                            </button>
                        </div>

                        <div class="lb-stats">
                            <div class="lb-stat">
                                <div class="lb-stat-value" id="total-requests">0</div>
                                <div class="lb-stat-label">Total Requests</div>
                            </div>
                            <div class="lb-stat">
                                <div class="lb-stat-value" id="server1-count">0</div>
                                <div class="lb-stat-label">Server 1</div>
                            </div>
                            <div class="lb-stat">
                                <div class="lb-stat-value" id="server2-count">0</div>
                                <div class="lb-stat-label">Server 2</div>
                            </div>
                            <div class="lb-stat">
                                <div class="lb-stat-value" id="server3-count">0</div>
                                <div class="lb-stat-label">Server 3</div>
                            </div>
                        </div>

                        <div class="lb-explanation" id="lb-explanation">
                            <strong>Round Robin:</strong> Requests are distributed sequentially to each server in order. Simple but doesn't account for server load or capacity.
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible">
                <div class="collapsible-header">
                    <span>Algorithms & Strategies</span>
                    <span class="collapsible-icon">&#9660;</span>
                </div>
                <div class="collapsible-content">
                    <h4>Common Algorithms</h4>
                    <ul>
                        <li><strong>Round Robin:</strong> Rotate through servers sequentially</li>
                        <li><strong>Weighted Round Robin:</strong> Based on server capacity</li>
                        <li><strong>Least Connections:</strong> Route to least busy server</li>
                        <li><strong>IP Hash:</strong> Consistent routing for same client</li>
                        <li><strong>Consistent Hashing:</strong> Minimize remapping on changes</li>
                    </ul>

                    <h4>L4 vs L7 Load Balancers</h4>
                    <ul>
                        <li><strong>L4 (Transport):</strong> TCP/UDP level, faster, less intelligent</li>
                        <li><strong>L7 (Application):</strong> HTTP level, can inspect content, more flexible</li>
                    </ul>

                    <h4 class="mt-3">NGINX Load Balancer Configuration Example</h4>
                    <div class="code-block">
                        <code>
# nginx.conf - Production-grade load balancing
http {
    # Define upstream servers with weights and health checks
    upstream api_servers {
        # Least connections algorithm - best for varying request times
        least_conn;

        # Server pool with weights (higher = more traffic)
        server 10.0.1.10:8080 weight=5 max_fails=3 fail_timeout=30s;
        server 10.0.1.11:8080 weight=5 max_fails=3 fail_timeout=30s;
        server 10.0.1.12:8080 weight=3 max_fails=3 fail_timeout=30s;

        # Backup server - only used when primary servers are down
        server 10.0.1.20:8080 backup;

        # Keep connections alive to reduce TCP handshake overhead
        keepalive 32;
    }

    server {
        listen 80;
        listen 443 ssl http2;

        location /api/ {
            proxy_pass http://api_servers;

            # Connection settings
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # Pass client info to backend
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Timeouts
            proxy_connect_timeout 5s;
            proxy_read_timeout 60s;

            # Retry on failure - only idempotent methods
            proxy_next_upstream error timeout http_502 http_503;
            proxy_next_upstream_tries 2;
        }

        # Health check endpoint (NGINX Plus feature, or use lua)
        location /health {
            access_log off;
            return 200 "healthy\n";
        }
    }
}
                        </code>
                    </div>

                    <h4 class="mt-3">HAProxy Configuration (Alternative)</h4>
                    <div class="code-block">
                        <code>
# haproxy.cfg - High-performance load balancing
global
    maxconn 50000
    log stdout format raw local0

defaults
    mode http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    option httplog
    option dontlognull

frontend http_front
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/server.pem

    # Route based on path
    acl is_api path_beg /api
    acl is_static path_beg /static

    use_backend api_servers if is_api
    use_backend static_servers if is_static
    default_backend api_servers

backend api_servers
    balance roundrobin
    option httpchk GET /health

    # Server definitions with health checks
    server api1 10.0.1.10:8080 check inter 5s fall 3 rise 2
    server api2 10.0.1.11:8080 check inter 5s fall 3 rise 2
    server api3 10.0.1.12:8080 check inter 5s fall 3 rise 2

backend static_servers
    balance leastconn
    server static1 10.0.2.10:80 check
    server static2 10.0.2.11:80 check

# Stats page for monitoring
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
                        </code>
                    </div>

                    <div class="card mt-2" style="background: var(--success-bg);">
                        <strong>Production Tips:</strong>
                        <ul>
                            <li><strong>Health checks:</strong> Always configure active health checks, not just passive failure detection</li>
                            <li><strong>Graceful degradation:</strong> Use backup servers and circuit breakers</li>
                            <li><strong>Session persistence:</strong> Use sticky sessions only when necessary (adds complexity)</li>
                            <li><strong>SSL termination:</strong> Terminate SSL at the load balancer to reduce backend CPU</li>
                        </ul>
                    </div>
                </div>
            </div>

            <h2 class="mt-4">Caching</h2>

            <!-- Interactive Cache Demo -->
            <div class="collapsible open">
                <div class="collapsible-header">
                    <span>üéÆ Interactive Cache-Aside Pattern Demo</span>
                    <span class="collapsible-icon">&#9660;</span>
                </div>
                <div class="collapsible-content">
                    <p class="text-muted">Watch how Cache-Aside works with cache hits and misses. The pattern shows the flow between App, Cache, and Database.</p>

                    <div class="cache-container" id="cache-demo">
                        <div class="cache-controls">
                            <button class="cache-btn hit" onclick="simulateCacheHit()">‚úÖ Simulate Cache Hit</button>
                            <button class="cache-btn miss" onclick="simulateCacheMiss()">‚ùå Simulate Cache Miss</button>
                        </div>

                        <div class="cache-visualization">
                            <div class="cache-component">
                                <div class="cache-box app" id="cache-app">
                                    <span class="icon">üì±</span>
                                    <span>Application</span>
                                </div>
                                <span style="color: #a0aec0; font-size: 0.8rem;">Requests data</span>
                            </div>

                            <div class="cache-arrow" id="arrow-app-cache"></div>

                            <div class="cache-component">
                                <div class="cache-box cache" id="cache-cache">
                                    <span class="icon">‚ö°</span>
                                    <span>Cache</span>
                                    <span style="font-size: 0.7rem; color: rgba(255,255,255,0.7);" id="cache-items">3 items</span>
                                </div>
                                <span style="color: #a0aec0; font-size: 0.8rem;">~1ms latency</span>
                            </div>

                            <div class="cache-arrow" id="arrow-cache-db"></div>

                            <div class="cache-component">
                                <div class="cache-box db" id="cache-db">
                                    <span class="icon">üóÑÔ∏è</span>
                                    <span>Database</span>
                                </div>
                                <span style="color: #a0aec0; font-size: 0.8rem;">~50ms latency</span>
                            </div>
                        </div>

                        <div class="cache-stats">
                            <div class="cache-stat">
                                <div class="cache-stat-value" id="cache-hits">0</div>
                                <div style="font-size: 0.8rem; color: #48bb78;">Cache Hits</div>
                            </div>
                            <div class="cache-stat">
                                <div class="cache-stat-value" id="cache-misses">0</div>
                                <div style="font-size: 0.8rem; color: #f56565;">Cache Misses</div>
                            </div>
                            <div class="cache-stat">
                                <div class="cache-stat-value hit-rate" id="cache-hit-rate">0%</div>
                                <div style="font-size: 0.8rem; color: #a0aec0;">Hit Rate</div>
                            </div>
                        </div>

                        <div class="cache-log" id="cache-log">
                            <div class="cache-log-entry">Cache demo ready. Click buttons to simulate requests.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible">
                <div class="collapsible-header">
                    <span>Caching Strategies & Patterns</span>
                    <span class="collapsible-icon">&#9660;</span>
                </div>
                <div class="collapsible-content">
                    <h4>Cache Patterns</h4>
                    <ul>
                        <li><strong>Cache-Aside (Lazy Loading):</strong> App manages cache - most common, simple to implement</li>
                        <li><strong>Read-Through:</strong> Cache library fetches from DB on miss - cleaner app code</li>
                        <li><strong>Write-Through:</strong> Sync write to cache AND DB - ensures consistency</li>
                        <li><strong>Write-Behind (Write-Back):</strong> Async write to DB - faster writes, eventual consistency</li>
                    </ul>

                    <h4>Eviction Policies</h4>
                    <ul>
                        <li><strong>LRU (Least Recently Used):</strong> Evicts oldest accessed items - good general purpose</li>
                        <li><strong>LFU (Least Frequently Used):</strong> Evicts least accessed items - good for stable access patterns</li>
                        <li><strong>TTL (Time To Live):</strong> Expires after set time - good for time-sensitive data</li>
                        <li><strong>FIFO (First In First Out):</strong> Simple queue eviction - predictable but not access-aware</li>
                    </ul>

                    <div class="card mt-2" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)); border-left: 4px solid #667eea;">
                        <strong>üí° Interview Tip:</strong> When discussing caching, always mention:
                        <ul style="margin-top: 0.5rem;">
                            <li><strong>Cache invalidation</strong> - "One of the two hard problems in CS"</li>
                            <li><strong>Cache stampede</strong> - What happens when cache expires and many requests hit DB</li>
                            <li><strong>Consistency trade-offs</strong> - Stale data vs performance</li>
                        </ul>
                    </div>
                </div>
            </div>

            <h2 class="mt-4">Self-Check Quiz</h2>
            <div class="quiz-container" id="module-quiz"></div>

            <div class="flex flex-between mt-4">
                <a href="index.html" class="btn btn-secondary">&larr; Back to Overview</a>
                <button class="btn btn-primary" onclick="completeModule()">Mark Complete &rarr;</button>
            </div>
        </main>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('open');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('open');
            });

            document.querySelectorAll('.sidebar-link[data-module]').forEach(link => {
                const moduleNum = parseInt(link.dataset.module);
                if (StaffEngPrep.ProgressTracker.isModuleComplete('systemDesign', moduleNum)) {
                    link.classList.add('completed');
                }
            });

            const quizQuestions = [
                {
                    question: "What is the main advantage of horizontal scaling?",
                    options: ["Simpler architecture", "Theoretically unlimited scaling", "Lower cost", "Faster single requests"],
                    correct: 1,
                    explanation: "Horizontal scaling allows adding more machines, enabling theoretically unlimited growth."
                },
                {
                    question: "Which caching pattern is most commonly used?",
                    options: ["Write-Through", "Write-Behind", "Cache-Aside", "Read-Through"],
                    correct: 2,
                    explanation: "Cache-Aside (lazy loading) is most common because the application controls caching logic."
                }
            ];
            const quiz = new StaffEngPrep.Quiz('module-quiz', quizQuestions);
            quiz.render();
        });

        function completeModule() {
            StaffEngPrep.ProgressTracker.markModuleComplete('systemDesign', 1);
            alert('Module 1 marked as complete!');
            window.location.href = 'module-02.html';
        }

        // ============================================
        // Interactive Load Balancer Demo
        // ============================================
        let lbAlgorithm = 'round-robin';
        let rrIndex = 0;
        let totalRequests = 0;
        let serverCounts = [0, 0, 0];
        let serverConnections = [2, 4, 7]; // Simulated current connections

        const lbExplanations = {
            'round-robin': '<strong>Round Robin:</strong> Requests are distributed sequentially to each server in order (1‚Üí2‚Üí3‚Üí1‚Üí2‚Üí3...). Simple but doesn\'t account for server load or capacity.',
            'weighted': '<strong>Weighted Round Robin:</strong> Servers receive requests proportional to their weight (Server 1: 3x, Server 2: 2x, Server 3: 1x). Better for heterogeneous servers.',
            'least-conn': '<strong>Least Connections:</strong> Routes to the server with fewest active connections. Ideal when request processing times vary significantly.',
            'random': '<strong>Random:</strong> Randomly selects a server. Simple implementation, statistically even distribution over time.'
        };

        function setLbAlgorithm(algo) {
            lbAlgorithm = algo;
            document.querySelectorAll('.lb-algo-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('lb-explanation').innerHTML = lbExplanations[algo];

            // Show/hide weight labels based on algorithm
            document.querySelectorAll('.weight-label').forEach(label => {
                label.style.opacity = algo === 'weighted' ? '1' : '0.3';
            });
        }

        function getNextServer() {
            switch (lbAlgorithm) {
                case 'round-robin':
                    const server = rrIndex % 3;
                    rrIndex++;
                    return server;

                case 'weighted':
                    // Weighted selection: Server 1 (weight 3), Server 2 (weight 2), Server 3 (weight 1)
                    const weights = [3, 2, 1];
                    const totalWeight = weights.reduce((a, b) => a + b, 0);
                    let random = Math.random() * totalWeight;
                    for (let i = 0; i < weights.length; i++) {
                        random -= weights[i];
                        if (random <= 0) return i;
                    }
                    return 0;

                case 'least-conn':
                    // Return server with least connections
                    let minConn = Infinity;
                    let minServer = 0;
                    serverConnections.forEach((conn, i) => {
                        if (conn < minConn) {
                            minConn = conn;
                            minServer = i;
                        }
                    });
                    return minServer;

                case 'random':
                    return Math.floor(Math.random() * 3);

                default:
                    return 0;
            }
        }

        function sendRequest() {
            const clientId = (totalRequests % 3) + 1;
            const targetServer = getNextServer();

            // Animate client
            const client = document.getElementById(`client-${clientId}`);
            client.classList.add('sending');
            setTimeout(() => client.classList.remove('sending'), 500);

            // Animate server receiving
            setTimeout(() => {
                const server = document.getElementById(`server-${targetServer + 1}`);
                server.classList.add('receiving');
                setTimeout(() => server.classList.remove('receiving'), 400);

                // Update stats
                totalRequests++;
                serverCounts[targetServer]++;
                serverConnections[targetServer]++;

                // Decrease connections after "processing"
                setTimeout(() => {
                    serverConnections[targetServer] = Math.max(1, serverConnections[targetServer] - 1);
                    updateLoadBars();
                }, 1000);

                updateLbStats();
            }, 200);
        }

        function updateLbStats() {
            document.getElementById('total-requests').textContent = totalRequests;
            document.getElementById('server1-count').textContent = serverCounts[0];
            document.getElementById('server2-count').textContent = serverCounts[1];
            document.getElementById('server3-count').textContent = serverCounts[2];
            updateLoadBars();
        }

        function updateLoadBars() {
            for (let i = 0; i < 3; i++) {
                const server = document.getElementById(`server-${i + 1}`);
                const loadFill = server.querySelector('.load-fill');
                const loadPercent = Math.min(100, 20 + serverConnections[i] * 10);
                loadFill.style.width = `${loadPercent}%`;

                if (loadPercent >= 80) {
                    server.classList.add('overloaded');
                } else {
                    server.classList.remove('overloaded');
                }
            }
        }

        function autoSendRequests() {
            const btn = document.getElementById('auto-send-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Sending...';

            let count = 0;
            const interval = setInterval(() => {
                sendRequest();
                count++;
                if (count >= 5) {
                    clearInterval(interval);
                    btn.disabled = false;
                    btn.textContent = 'üîÑ Auto Send (5 req)';
                }
            }, 400);
        }

        // ============================================
        // Interactive Cache Demo
        // ============================================
        let cacheHits = 0;
        let cacheMisses = 0;
        let cacheSize = 3;

        function addCacheLog(message, type) {
            const log = document.getElementById('cache-log');
            const entry = document.createElement('div');
            entry.className = `cache-log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.insertBefore(entry, log.firstChild);

            // Keep only last 10 entries
            while (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        }

        function updateCacheStats() {
            document.getElementById('cache-hits').textContent = cacheHits;
            document.getElementById('cache-misses').textContent = cacheMisses;

            const total = cacheHits + cacheMisses;
            const hitRate = total > 0 ? Math.round((cacheHits / total) * 100) : 0;
            document.getElementById('cache-hit-rate').textContent = `${hitRate}%`;
            document.getElementById('cache-items').textContent = `${cacheSize} items`;
        }

        function animateComponent(id, duration = 500) {
            const el = document.getElementById(id);
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), duration);
        }

        function animateArrow(id, duration = 300) {
            const el = document.getElementById(id);
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), duration);
        }

        function simulateCacheHit() {
            const key = `user_${Math.floor(Math.random() * 100)}`;

            // Step 1: App requests data
            animateComponent('cache-app');
            addCacheLog(`App requests key: ${key}`, '');

            // Step 2: Check cache
            setTimeout(() => {
                animateArrow('arrow-app-cache');
            }, 200);

            // Step 3: Cache HIT!
            setTimeout(() => {
                animateComponent('cache-cache');
                cacheHits++;
                addCacheLog(`CACHE HIT! Found ${key} in cache (1ms)`, 'hit');
                updateCacheStats();
            }, 500);

            // Step 4: Return to app
            setTimeout(() => {
                animateArrow('arrow-app-cache');
                animateComponent('cache-app');
                addCacheLog(`Returned data to app - Total: 1ms`, 'hit');
            }, 800);
        }

        function simulateCacheMiss() {
            const key = `product_${Math.floor(Math.random() * 1000)}`;

            // Step 1: App requests data
            animateComponent('cache-app');
            addCacheLog(`App requests key: ${key}`, '');

            // Step 2: Check cache
            setTimeout(() => {
                animateArrow('arrow-app-cache');
            }, 200);

            // Step 3: Cache MISS
            setTimeout(() => {
                animateComponent('cache-cache');
                cacheMisses++;
                addCacheLog(`CACHE MISS! ${key} not in cache`, 'miss');
                updateCacheStats();
            }, 500);

            // Step 4: Fetch from DB
            setTimeout(() => {
                animateArrow('arrow-cache-db');
                addCacheLog(`Fetching ${key} from database...`, '');
            }, 800);

            // Step 5: DB returns data
            setTimeout(() => {
                animateComponent('cache-db');
                addCacheLog(`Database returned ${key} (50ms)`, '');
            }, 1300);

            // Step 6: Update cache
            setTimeout(() => {
                animateArrow('arrow-cache-db');
                animateComponent('cache-cache');
                cacheSize = Math.min(10, cacheSize + 1);
                addCacheLog(`Stored ${key} in cache`, '');
                updateCacheStats();
            }, 1600);

            // Step 7: Return to app
            setTimeout(() => {
                animateArrow('arrow-app-cache');
                animateComponent('cache-app');
                addCacheLog(`Returned data to app - Total: 51ms`, 'miss');
            }, 1900);
        }

        // Initialize load bars
        updateLoadBars();
    </script>
</body>
</html>
