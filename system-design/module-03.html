<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 3: Distributed Systems - Staff Engineer Prep</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        /* Interactive CAP Theorem Visualization */
        .cap-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 1rem;
            margin: 1rem 0;
        }

        .cap-triangle {
            position: relative;
            width: 350px;
            height: 300px;
            margin-bottom: 2rem;
        }

        .cap-node {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 4px solid transparent;
            font-weight: 600;
            color: white;
            text-align: center;
            font-size: 0.85rem;
        }

        .cap-node.consistency {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .cap-node.availability {
            bottom: 0;
            left: 0;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .cap-node.partition {
            bottom: 0;
            right: 0;
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .cap-node:hover, .cap-node.active {
            transform: scale(1.15);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .cap-node.consistency:hover, .cap-node.consistency.active {
            transform: translateX(-50%) scale(1.15);
        }

        .cap-node.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .cap-node.dimmed {
            opacity: 0.3;
            transform: scale(0.9);
        }

        .cap-node.consistency.dimmed {
            transform: translateX(-50%) scale(0.9);
        }

        .cap-edge {
            position: absolute;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            transform-origin: left center;
            transition: all 0.3s ease;
        }

        .cap-edge.highlighted {
            background: linear-gradient(90deg, #ffd700, #ffed4a);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .cap-edge-ca {
            width: 140px;
            top: 85px;
            left: 70px;
            transform: rotate(60deg);
        }

        .cap-edge-cp {
            width: 140px;
            top: 85px;
            right: 70px;
            transform: rotate(-60deg);
            transform-origin: right center;
        }

        .cap-edge-ap {
            width: 150px;
            bottom: 50px;
            left: 100px;
        }

        .cap-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .cap-scenario-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .cap-scenario-btn.cp {
            background: linear-gradient(135deg, #667eea 0%, #eb3349 100%);
            color: white;
        }

        .cap-scenario-btn.ap {
            background: linear-gradient(135deg, #11998e 0%, #eb3349 100%);
            color: white;
        }

        .cap-scenario-btn.ca {
            background: linear-gradient(135deg, #667eea 0%, #38ef7d 100%);
            color: white;
        }

        .cap-scenario-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .cap-scenario-btn.active {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            border: 2px solid #ffd700;
        }

        .cap-explanation {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: white;
            max-width: 500px;
            text-align: center;
            min-height: 120px;
        }

        .cap-explanation h4 {
            margin-bottom: 0.75rem;
            color: #ffd700;
        }

        .cap-examples {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0.75rem;
        }

        .cap-example-tag {
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            font-size: 0.8rem;
        }

        /* Animated Network Partition Demo */
        .partition-demo {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            border-radius: 1rem;
            padding: 2rem;
            margin: 1.5rem 0;
        }

        .partition-grid {
            display: flex;
            justify-content: space-around;
            align-items: center;
            min-height: 200px;
            position: relative;
        }

        .partition-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: all 0.5s ease;
        }

        .partition-zone.zone-a {
            border-color: #667eea;
        }

        .partition-zone.zone-b {
            border-color: #eb3349;
        }

        .partition-zone.partitioned {
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .server-node {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .server-node.leader {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }

        .server-node.follower {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }

        .server-node.unavailable {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            animation: pulse-error 1s infinite;
        }

        @keyframes pulse-error {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .server-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .network-line {
            position: absolute;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #eb3349);
            top: 50%;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            transition: all 0.5s ease;
        }

        .network-line.broken {
            background: transparent;
            border-top: 3px dashed #ff6b6b;
        }

        .network-line.broken::after {
            content: '‚ö°';
            position: absolute;
            left: 50%;
            top: -15px;
            transform: translateX(-50%);
            font-size: 1.5rem;
            animation: flash 0.5s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .partition-status {
            text-align: center;
            color: white;
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
        }

        .partition-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .partition-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }

        .partition-btn.normal {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .partition-btn.partition {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .partition-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Raft Animation Styles */
        .raft-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            border-radius: 1rem;
            padding: 2rem;
            margin: 1.5rem 0;
        }

        .raft-nodes {
            display: flex;
            justify-content: space-around;
            align-items: center;
            min-height: 150px;
            margin-bottom: 2rem;
        }

        .raft-node {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: all 0.5s ease;
            position: relative;
        }

        .raft-node.follower {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border: 3px solid #4a5568;
        }

        .raft-node.candidate {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
            border: 3px solid #ffd700;
            animation: pulse-candidate 1s infinite;
        }

        @keyframes pulse-candidate {
            0%, 100% { box-shadow: 0 0 0 0 rgba(246, 173, 85, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(246, 173, 85, 0); }
        }

        .raft-node.leader {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            border: 3px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .raft-node .term {
            font-size: 0.7rem;
            margin-top: 0.25rem;
            opacity: 0.8;
        }

        .raft-node .vote-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #48bb78;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .raft-node.candidate .vote-count {
            opacity: 1;
        }

        .raft-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .raft-log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeInLog 0.3s ease;
        }

        @keyframes fadeInLog {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .raft-log-entry.election {
            color: #f6ad55;
        }

        .raft-log-entry.vote {
            color: #48bb78;
        }

        .raft-log-entry.leader {
            color: #ffd700;
        }

        .raft-log-entry.heartbeat {
            color: #667eea;
        }

        .raft-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .raft-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }

        .raft-btn.start {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .raft-btn.stop {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .raft-btn.kill {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }

        .raft-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .raft-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">StaffEngPrep</a>
            <ul class="nav-links">
                <li><a href="../coding-rounds/index.html">Coding</a></li>
                <li><a href="index.html" style="color: var(--primary-color);">System Design</a></li>
                <li><a href="../company-specific/index.html">Companies</a></li>
                <li><a href="../behavioral/index.html">Behavioral</a></li>
            </ul>
        </div>
    </nav>

    <div class="layout-with-sidebar">
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Getting Started</div>
                    <a href="index.html" class="sidebar-link">Introduction</a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Core Concepts</div>
                    <a href="module-01.html" class="sidebar-link" data-module="1">
                        <span class="sidebar-link-number">1</span>Scalability Fundamentals
                    </a>
                    <a href="module-02.html" class="sidebar-link" data-module="2">
                        <span class="sidebar-link-number">2</span>Database Systems
                    </a>
                    <a href="module-03.html" class="sidebar-link active" data-module="3">
                        <span class="sidebar-link-number">3</span>Distributed Systems
                    </a>
                    <a href="module-04.html" class="sidebar-link" data-module="4">
                        <span class="sidebar-link-number">4</span>Storage & Data Processing
                    </a>
                    <a href="module-05.html" class="sidebar-link" data-module="5">
                        <span class="sidebar-link-number">5</span>Seminal Papers
                    </a>
                    <a href="module-09.html" class="sidebar-link" data-module="9">
                        <span class="sidebar-link-number">6</span>API Design
                    </a>
                    <a href="module-10.html" class="sidebar-link" data-module="10">
                        <span class="sidebar-link-number">7</span>Numbers to Know
                    </a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Patterns</div>
                    <a href="module-11.html" class="sidebar-link" data-module="11">
                        <span class="sidebar-link-number">8</span>Real-time Updates
                    </a>
                    <a href="module-12.html" class="sidebar-link" data-module="12">
                        <span class="sidebar-link-number">9</span>Rate Limiting
                    </a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Problem Breakdowns</div>
                    <a href="module-06.html" class="sidebar-link" data-module="6">
                        <span class="sidebar-link-number">10</span>Common Problems
                    </a>
                    <a href="problems/url-shortener.html" class="sidebar-link">URL Shortener</a>
                    <a href="problems/news-feed.html" class="sidebar-link">News Feed</a>
                    <a href="problems/chat-system.html" class="sidebar-link">Chat System</a>
                    <a href="problems/video-streaming.html" class="sidebar-link">Video Streaming</a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Interview Prep</div>
                    <a href="module-07.html" class="sidebar-link" data-module="7">
                        <span class="sidebar-link-number">11</span>Framework Mastery
                    </a>
                    <a href="module-08.html" class="sidebar-link" data-module="8">
                        <span class="sidebar-link-number">12</span>Mock Interviews
                    </a>
                </div>
            </nav>
        </aside>

        <button class="sidebar-toggle" id="sidebarToggle">&#9776;</button>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <main class="main-content">
            <h1>Module 3: Distributed Systems Fundamentals</h1>

        <div class="card mt-3">
            <h3>Learning Objectives</h3>
            <ul>
                <li>Understand CAP theorem and its practical implications</li>
                <li>Learn consensus algorithms (Paxos, Raft)</li>
                <li>Master consistency models and their trade-offs</li>
                <li>Apply distributed systems patterns in design</li>
            </ul>
        </div>

        <h2 class="mt-4">CAP Theorem</h2>

        <div class="collapsible open">
            <div class="collapsible-header">
                <span>The CAP Trade-off - Interactive Explorer</span>
                <span class="collapsible-icon">&#9660;</span>
            </div>
            <div class="collapsible-content">
                <p class="text-muted mb-2">Click on the scenarios below to see how different systems make trade-offs.</p>

                <!-- Interactive CAP Triangle -->
                <div class="cap-container" id="cap-demo">
                    <div class="cap-triangle">
                        <div class="cap-edge cap-edge-ca" id="edge-ca"></div>
                        <div class="cap-edge cap-edge-cp" id="edge-cp"></div>
                        <div class="cap-edge cap-edge-ap" id="edge-ap"></div>

                        <div class="cap-node consistency" id="cap-c">
                            <span style="font-size: 1.5rem;">üîí</span>
                            <span>Consistency</span>
                        </div>
                        <div class="cap-node availability" id="cap-a">
                            <span style="font-size: 1.5rem;">‚úÖ</span>
                            <span>Availability</span>
                        </div>
                        <div class="cap-node partition" id="cap-p">
                            <span style="font-size: 1.5rem;">üåê</span>
                            <span>Partition<br>Tolerance</span>
                        </div>
                    </div>

                    <div class="cap-controls">
                        <button class="cap-scenario-btn cp" onclick="showCapScenario('cp')">CP Systems</button>
                        <button class="cap-scenario-btn ap" onclick="showCapScenario('ap')">AP Systems</button>
                        <button class="cap-scenario-btn ca" onclick="showCapScenario('ca')">CA Systems</button>
                    </div>

                    <div class="cap-explanation" id="cap-explanation">
                        <h4>Choose a Scenario</h4>
                        <p>Click on CP, AP, or CA to see how different systems prioritize these properties and the trade-offs they make.</p>
                    </div>
                </div>

                <h4>Definitions</h4>
                <ul>
                    <li><strong>Consistency:</strong> Every read receives the most recent write</li>
                    <li><strong>Availability:</strong> Every request receives a response (no timeout)</li>
                    <li><strong>Partition Tolerance:</strong> System continues operating despite network failures</li>
                </ul>

                <div class="card mt-2" style="background: linear-gradient(135deg, rgba(17, 153, 142, 0.2), rgba(56, 239, 125, 0.2)); border-left: 4px solid #38ef7d;">
                    <strong>üéØ Reality Check:</strong> In distributed systems, network partitions WILL happen. Partition Tolerance is not optional - it's a fact of life. The real choice during a partition is between Consistency and Availability.
                </div>

                <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
                    <thead>
                        <tr style="background: var(--border-color);">
                            <th style="padding: 0.75rem; border: 1px solid var(--border-color);">Choose Consistency (CP)</th>
                            <th style="padding: 0.75rem; border: 1px solid var(--border-color);">Choose Availability (AP)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">üí∞ Financial transactions (banks, payment)</td>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">üì± Social media feeds (Twitter, Facebook)</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">üì¶ Inventory management (prevent overselling)</td>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">üé¨ Content delivery (Netflix streaming)</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">üîê User authentication (security critical)</td>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">üìä Analytics / Logging (eventual accuracy OK)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Interactive Network Partition Demo -->
        <div class="collapsible">
            <div class="collapsible-header">
                <span>Live Demo: Network Partition Simulation</span>
                <span class="collapsible-icon">&#9660;</span>
            </div>
            <div class="collapsible-content">
                <p>See what happens when a network partition occurs in a distributed system. Watch how CP vs AP systems respond differently.</p>

                <div class="partition-demo" id="partition-demo">
                    <div class="partition-controls">
                        <button class="partition-btn normal" onclick="setPartitionState('normal')">üü¢ Normal Operation</button>
                        <button class="partition-btn partition" onclick="setPartitionState('partition')">‚ö° Simulate Partition</button>
                    </div>

                    <div class="partition-grid">
                        <div class="partition-zone zone-a" id="zone-a">
                            <div class="server-node leader" id="server-1">
                                <span class="server-icon">üëë</span>
                                <span>Leader</span>
                            </div>
                            <div class="server-node follower" id="server-2">
                                <span class="server-icon">üì°</span>
                                <span>Node 2</span>
                            </div>
                        </div>

                        <div class="network-line" id="network-line"></div>

                        <div class="partition-zone zone-b" id="zone-b">
                            <div class="server-node follower" id="server-3">
                                <span class="server-icon">üì°</span>
                                <span>Node 3</span>
                            </div>
                            <div class="server-node follower" id="server-4">
                                <span class="server-icon">üì°</span>
                                <span>Node 4</span>
                            </div>
                            <div class="server-node follower" id="server-5">
                                <span class="server-icon">üì°</span>
                                <span>Node 5</span>
                            </div>
                        </div>
                    </div>

                    <div class="partition-status" id="partition-status">
                        <strong>Status:</strong> All nodes communicating normally. Cluster is healthy with 5/5 nodes.
                    </div>
                </div>
            </div>
        </div>

        <h2 class="mt-4">Consistency Models</h2>

        <div class="collapsible">
            <div class="collapsible-header">
                <span>Types of Consistency</span>
                <span class="collapsible-icon">&#9660;</span>
            </div>
            <div class="collapsible-content">
                <h4>Strong Consistency</h4>
                <p>Read always returns the latest write. All nodes see the same data at the same time.</p>

                <h4>Eventual Consistency</h4>
                <p>Reads may return stale data, but eventually all replicas converge to the same value.</p>

                <h4>Causal Consistency</h4>
                <p>Preserves cause-effect relationships. If A causes B, everyone sees A before B.</p>

                <h4>Read-Your-Writes</h4>
                <p>User always sees their own writes immediately, even if other users see stale data.</p>

                <div class="diagram-container">
                    <div class="mermaid">
flowchart LR
    Strong[Strong<br>Linearizable] --> Causal[Causal]
    Causal --> RYW[Read-Your-Writes]
    RYW --> Eventual[Eventual]

    style Strong fill:#d1fae5
    style Eventual fill:#fee2e2
                    </div>
                </div>
            </div>
        </div>

        <h2 class="mt-4">Consensus Algorithms</h2>

        <div class="collapsible">
            <div class="collapsible-header">
                <span>Paxos and Raft</span>
                <span class="collapsible-icon">&#9660;</span>
            </div>
            <div class="collapsible-content">
                <h4>Why Consensus?</h4>
                <p>Multiple nodes must agree on a value even if some nodes fail.</p>

                <div class="diagram-container">
                    <div class="mermaid">
sequenceDiagram
    participant L as Leader
    participant R1 as Replica 1
    participant R2 as Replica 2

    L->>R1: Prepare(n)
    L->>R2: Prepare(n)
    R1-->>L: Promise(n)
    R2-->>L: Promise(n)
    L->>R1: Accept(n, v)
    L->>R2: Accept(n, v)
    R1-->>L: Accepted
    R2-->>L: Accepted
    L->>L: Commit
                    </div>
                </div>

                <h4>Raft (Simpler Alternative)</h4>
                <ul>
                    <li><strong>Leader Election:</strong> One node becomes leader via majority vote</li>
                    <li><strong>Log Replication:</strong> Leader replicates entries to followers</li>
                    <li><strong>Safety:</strong> Committed entries are durable across failures</li>
                </ul>

                <!-- Interactive Raft Election Demo -->
                <h4 class="mt-3">üéÆ Interactive Raft Election Demo</h4>
                <p class="text-muted">Watch leader election in action. Click "Kill Leader" to trigger a new election.</p>

                <div class="raft-container" id="raft-demo">
                    <div class="raft-controls">
                        <button class="raft-btn start" id="raft-start" onclick="startRaft()">‚ñ∂ Start Cluster</button>
                        <button class="raft-btn stop" id="raft-stop" onclick="stopRaft()" disabled>‚èπ Stop</button>
                        <button class="raft-btn kill" id="raft-kill" onclick="killLeader()" disabled>üíÄ Kill Leader</button>
                    </div>

                    <div class="raft-nodes" id="raft-nodes">
                        <div class="raft-node follower" id="raft-node-1">
                            <span>Node 1</span>
                            <span class="term">Term: 0</span>
                            <span class="vote-count">0</span>
                        </div>
                        <div class="raft-node follower" id="raft-node-2">
                            <span>Node 2</span>
                            <span class="term">Term: 0</span>
                            <span class="vote-count">0</span>
                        </div>
                        <div class="raft-node follower" id="raft-node-3">
                            <span>Node 3</span>
                            <span class="term">Term: 0</span>
                            <span class="vote-count">0</span>
                        </div>
                        <div class="raft-node follower" id="raft-node-4">
                            <span>Node 4</span>
                            <span class="term">Term: 0</span>
                            <span class="vote-count">0</span>
                        </div>
                        <div class="raft-node follower" id="raft-node-5">
                            <span>Node 5</span>
                            <span class="term">Term: 0</span>
                            <span class="vote-count">0</span>
                        </div>
                    </div>

                    <div class="raft-log" id="raft-log">
                        <div class="raft-log-entry">Waiting to start cluster...</div>
                    </div>
                </div>

                <h4 class="mt-3">Raft Leader Election - Implementation</h4>
                <div class="code-block">
                    <code>
# Python - Raft Leader Election State Machine

import random
import time
from enum import Enum
from dataclasses import dataclass
from typing import List, Optional
import asyncio

class NodeState(Enum):
    FOLLOWER = "follower"
    CANDIDATE = "candidate"
    LEADER = "leader"

@dataclass
class RaftNode:
    node_id: str
    state: NodeState = NodeState.FOLLOWER
    current_term: int = 0
    voted_for: Optional[str] = None
    log: List[dict] = None
    commit_index: int = 0

    # Timing (in seconds)
    election_timeout_min: float = 0.150
    election_timeout_max: float = 0.300
    heartbeat_interval: float = 0.050

    def __post_init__(self):
        self.log = self.log or []
        self.reset_election_timer()

    def reset_election_timer(self):
        """Randomized timeout prevents split votes."""
        self.election_deadline = time.time() + random.uniform(
            self.election_timeout_min,
            self.election_timeout_max
        )

    async def run(self, cluster: List['RaftNode']):
        """Main event loop."""
        while True:
            if self.state == NodeState.FOLLOWER:
                await self._run_follower()
            elif self.state == NodeState.CANDIDATE:
                await self._run_candidate(cluster)
            elif self.state == NodeState.LEADER:
                await self._run_leader(cluster)

    async def _run_follower(self):
        """Follower: Wait for heartbeats or timeout."""
        if time.time() >= self.election_deadline:
            print(f"[{self.node_id}] Election timeout - becoming candidate")
            self.state = NodeState.CANDIDATE
        await asyncio.sleep(0.010)

    async def _run_candidate(self, cluster: List['RaftNode']):
        """Candidate: Request votes from all nodes."""
        self.current_term += 1
        self.voted_for = self.node_id
        votes_received = 1  # Vote for self

        print(f"[{self.node_id}] Starting election for term {self.current_term}")

        # Request votes from all other nodes
        for node in cluster:
            if node.node_id != self.node_id:
                vote_granted = await self._request_vote(node)
                if vote_granted:
                    votes_received += 1

        # Check if we won
        majority = len(cluster) // 2 + 1
        if votes_received >= majority:
            print(f"[{self.node_id}] Won election with {votes_received} votes")
            self.state = NodeState.LEADER
        else:
            print(f"[{self.node_id}] Lost election, reverting to follower")
            self.state = NodeState.FOLLOWER
            self.reset_election_timer()

    async def _request_vote(self, target: 'RaftNode') -> bool:
        """
        RequestVote RPC
        Returns True if vote granted
        """
        # If target has higher term, we're stale
        if target.current_term > self.current_term:
            self.current_term = target.current_term
            self.state = NodeState.FOLLOWER
            return False

        # Grant vote if:
        # 1. Target hasn't voted this term, OR voted for us
        # 2. Our log is at least as up-to-date
        if target.current_term < self.current_term:
            target.current_term = self.current_term
            target.voted_for = None

        if target.voted_for is None or target.voted_for == self.node_id:
            # Log completeness check
            if self._is_log_up_to_date(target):
                target.voted_for = self.node_id
                target.reset_election_timer()
                return True

        return False

    def _is_log_up_to_date(self, other: 'RaftNode') -> bool:
        """Check if our log is at least as complete as theirs."""
        our_last_term = self.log[-1]['term'] if self.log else 0
        our_last_index = len(self.log)
        their_last_term = other.log[-1]['term'] if other.log else 0
        their_last_index = len(other.log)

        if our_last_term != their_last_term:
            return our_last_term > their_last_term
        return our_last_index >= their_last_index

    async def _run_leader(self, cluster: List['RaftNode']):
        """Leader: Send heartbeats to maintain authority."""
        for node in cluster:
            if node.node_id != self.node_id:
                await self._send_heartbeat(node)

        await asyncio.sleep(self.heartbeat_interval)

    async def _send_heartbeat(self, target: 'RaftNode'):
        """AppendEntries RPC with empty entries = heartbeat."""
        if target.current_term > self.current_term:
            # Step down - there's a newer leader
            self.state = NodeState.FOLLOWER
            self.current_term = target.current_term
            return

        # Reset follower's election timer
        target.reset_election_timer()
        target.state = NodeState.FOLLOWER


# Usage Example
async def simulate_raft():
    nodes = [RaftNode(f"node-{i}") for i in range(5)]

    # Simulate network partition - node 0 and 1 can't reach others
    # This would cause a new election among nodes 2, 3, 4
    pass
                    </code>
                </div>

                <div class="card mt-2">
                    <strong>Used in:</strong> etcd, Consul, CockroachDB, TiDB
                </div>
            </div>
        </div>

        <h2 class="mt-4">Failure Scenarios in Distributed Systems</h2>

        <div class="collapsible">
            <div class="collapsible-header">
                <span>Network Partitions</span>
                <span class="collapsible-icon">&#9660;</span>
            </div>
            <div class="collapsible-content">
                <div class="diagram-container">
                    <div class="mermaid">
flowchart TB
    subgraph "Partition A"
        N1[Node 1<br>Leader]
        N2[Node 2]
    end

    subgraph "Partition B"
        N3[Node 3]
        N4[Node 4]
        N5[Node 5<br>New Leader]
    end

    N1 -.->|"X Blocked X"| N3
    N2 -.->|"X Blocked X"| N4

    style N1 fill:#fee2e2
    style N5 fill:#d1fae5
                    </div>
                </div>

                <h4>What Happens During a Partition</h4>
                <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
                    <thead>
                        <tr style="background: var(--border-color);">
                            <th style="padding: 0.75rem; border: 1px solid var(--border-color);">System Type</th>
                            <th style="padding: 0.75rem; border: 1px solid var(--border-color);">Behavior</th>
                            <th style="padding: 0.75rem; border: 1px solid var(--border-color);">Example</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">CP System</td>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">Minority partition becomes unavailable; majority continues</td>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">Zookeeper, etcd, Consul</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">AP System</td>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">Both partitions accept writes; conflicts resolved later</td>
                            <td style="padding: 0.75rem; border: 1px solid var(--border-color);">Cassandra, DynamoDB</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Split-Brain Prevention</h4>
                <div class="code-block">
                    <code>
# Go - Quorum-based writes to prevent split-brain

type QuorumWriter struct {
    nodes      []string
    quorumSize int  // Usually: (n/2) + 1
}

func (qw *QuorumWriter) Write(key string, value []byte) error {
    successCount := 0
    errors := make([]error, 0)

    // Fan out writes to all nodes
    for _, node := range qw.nodes {
        err := qw.writeToNode(node, key, value)
        if err != nil {
            errors = append(errors, err)
        } else {
            successCount++
        }
    }

    // Require quorum for success
    if successCount >= qw.quorumSize {
        return nil  // Success - majority agreed
    }

    return fmt.Errorf("quorum not reached: %d/%d succeeded, errors: %v",
        successCount, qw.quorumSize, errors)
}

// During partition:
// - 5-node cluster splits 2-3
// - Quorum = 3
// - Partition with 3 nodes can write
// - Partition with 2 nodes CANNOT write (prevents split-brain)
                    </code>
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span>Cascading Failures</span>
                <span class="collapsible-icon">&#9660;</span>
            </div>
            <div class="collapsible-content">
                <p>One failure triggers a chain reaction across the system.</p>

                <div class="diagram-container">
                    <div class="mermaid">
sequenceDiagram
    participant LB as Load Balancer
    participant S1 as Server 1
    participant S2 as Server 2
    participant S3 as Server 3
    participant DB as Database

    Note over S1: Server 1 fails
    LB->>S2: Redirect traffic
    LB->>S3: Redirect traffic
    Note over S2,S3: Load increases 50%
    S2->>DB: More queries
    S3->>DB: More queries
    Note over DB: Connection pool exhausted
    DB--xS2: Connection refused
    DB--xS3: Connection refused
    Note over S2,S3: Servers start failing
    Note over LB,DB: Complete outage
                    </div>
                </div>

                <h4>Prevention Strategies</h4>
                <div class="code-block">
                    <code>
# Python - Circuit Breaker Pattern

import time
from enum import Enum
from dataclasses import dataclass
from typing import Callable, Any

class CircuitState(Enum):
    CLOSED = "closed"      # Normal operation
    OPEN = "open"          # Failing - reject requests
    HALF_OPEN = "half_open"  # Testing recovery

@dataclass
class CircuitBreaker:
    failure_threshold: int = 5
    recovery_timeout: float = 30.0
    half_open_max_calls: int = 3

    def __post_init__(self):
        self.state = CircuitState.CLOSED
        self.failure_count = 0
        self.last_failure_time = 0
        self.half_open_calls = 0

    def call(self, func: Callable, *args, **kwargs) -> Any:
        if self.state == CircuitState.OPEN:
            if time.time() - self.last_failure_time > self.recovery_timeout:
                self.state = CircuitState.HALF_OPEN
                self.half_open_calls = 0
            else:
                raise CircuitBreakerOpen("Circuit breaker is open")

        try:
            result = func(*args, **kwargs)
            self._on_success()
            return result
        except Exception as e:
            self._on_failure()
            raise

    def _on_success(self):
        if self.state == CircuitState.HALF_OPEN:
            self.half_open_calls += 1
            if self.half_open_calls >= self.half_open_max_calls:
                # Recovered!
                self.state = CircuitState.CLOSED
                self.failure_count = 0
        elif self.state == CircuitState.CLOSED:
            self.failure_count = 0

    def _on_failure(self):
        self.failure_count += 1
        self.last_failure_time = time.time()

        if self.state == CircuitState.HALF_OPEN:
            # Recovery failed
            self.state = CircuitState.OPEN
        elif self.failure_count >= self.failure_threshold:
            # Too many failures
            self.state = CircuitState.OPEN
            print(f"Circuit breaker OPEN after {self.failure_count} failures")


# Usage
db_circuit = CircuitBreaker(failure_threshold=5, recovery_timeout=30)

def query_database(sql):
    return db_circuit.call(actual_db_query, sql)
                    </code>
                </div>

                <h4>Additional Mitigation Techniques</h4>
                <ul>
                    <li><strong>Bulkheads:</strong> Isolate components so failure in one doesn't affect others</li>
                    <li><strong>Rate limiting:</strong> Prevent any single source from overwhelming the system</li>
                    <li><strong>Graceful degradation:</strong> Return cached/stale data instead of errors</li>
                    <li><strong>Load shedding:</strong> Reject low-priority requests during overload</li>
                </ul>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span>Recovery Strategies</span>
                <span class="collapsible-icon">&#9660;</span>
            </div>
            <div class="collapsible-content">
                <h4>Exponential Backoff with Jitter</h4>
                <div class="code-block">
                    <code>
# Python - Production-grade retry with backoff

import random
import time
from functools import wraps
from typing import Callable, Tuple, Type

def retry_with_backoff(
    max_retries: int = 5,
    base_delay: float = 1.0,
    max_delay: float = 60.0,
    exponential_base: float = 2.0,
    jitter: bool = True,
    retryable_exceptions: Tuple[Type[Exception], ...] = (Exception,)
):
    """
    Decorator for retrying with exponential backoff.

    Args:
        max_retries: Maximum number of retry attempts
        base_delay: Initial delay in seconds
        max_delay: Maximum delay cap
        exponential_base: Multiplier for each retry
        jitter: Add randomness to prevent thundering herd
        retryable_exceptions: Tuple of exceptions to retry on
    """
    def decorator(func: Callable):
        @wraps(func)
        def wrapper(*args, **kwargs):
            last_exception = None

            for attempt in range(max_retries + 1):
                try:
                    return func(*args, **kwargs)
                except retryable_exceptions as e:
                    last_exception = e

                    if attempt == max_retries:
                        break

                    # Calculate delay with exponential backoff
                    delay = min(
                        base_delay * (exponential_base ** attempt),
                        max_delay
                    )

                    # Add jitter (0.5x to 1.5x)
                    if jitter:
                        delay *= (0.5 + random.random())

                    print(f"Attempt {attempt + 1} failed: {e}. "
                          f"Retrying in {delay:.2f}s...")
                    time.sleep(delay)

            raise last_exception

        return wrapper
    return decorator


# Usage
@retry_with_backoff(
    max_retries=5,
    base_delay=1.0,
    retryable_exceptions=(ConnectionError, TimeoutError)
)
def call_external_service(data):
    response = requests.post("https://api.service.com", json=data)
    response.raise_for_status()
    return response.json()
                    </code>
                </div>

                <h4>Graceful Degradation Pattern</h4>
                <div class="code-block">
                    <code>
# Python - Fallback chain for resilient services

class ResilientService:
    def __init__(self, primary_db, cache, static_fallback):
        self.primary_db = primary_db
        self.cache = cache
        self.static_fallback = static_fallback

    async def get_user_profile(self, user_id: str) -> dict:
        # Try primary source
        try:
            profile = await self.primary_db.get_user(user_id)
            # Update cache for next time
            await self.cache.set(f"user:{user_id}", profile, ttl=300)
            return profile
        except DatabaseError:
            pass  # Fall through to cache

        # Try cache (might be stale)
        try:
            cached = await self.cache.get(f"user:{user_id}")
            if cached:
                return {**cached, "_stale": True}
        except CacheError:
            pass  # Fall through to static

        # Return static/default response
        return {
            "user_id": user_id,
            "name": "Unknown User",
            "_degraded": True
        }
                    </code>
                </div>
            </div>
        </div>

        <h2 class="mt-4">Consistent Hashing</h2>

        <div class="collapsible">
            <div class="collapsible-header">
                <span>Distributed Data Placement</span>
                <span class="collapsible-icon">&#9660;</span>
            </div>
            <div class="collapsible-content">
                <div class="diagram-container">
                    <div class="mermaid">
graph TD
    subgraph "Hash Ring"
        N1((Node A))
        N2((Node B))
        N3((Node C))
    end
                    </div>
                </div>

                <h4>How It Works</h4>
                <ol>
                    <li>Hash nodes and keys onto a ring (0 to 2^n)</li>
                    <li>Key belongs to first node clockwise</li>
                    <li>Virtual nodes: Each physical node has multiple positions</li>
                </ol>

                <h4>Benefits</h4>
                <ul>
                    <li>Minimal remapping when nodes added/removed</li>
                    <li>Even distribution with virtual nodes</li>
                    <li>No central directory needed</li>
                </ul>

                <div class="card mt-2">
                    <strong>Used in:</strong> Cassandra, DynamoDB, Memcached, Chord
                </div>
            </div>
        </div>

        <h2 class="mt-4">Self-Check Quiz</h2>
        <div class="quiz-container" id="module-quiz"></div>

            <div class="flex flex-between mt-4">
                <a href="module-02.html" class="btn btn-secondary">&larr; Previous Module</a>
                <button class="btn btn-primary" onclick="completeModule()">Mark Complete &rarr;</button>
            </div>
        </main>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        // Sidebar toggle for mobile
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('open');
        });

        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('open');
        });

        // Update sidebar links based on completion status
        document.querySelectorAll('.sidebar-link[data-module]').forEach(link => {
            const moduleNum = parseInt(link.dataset.module);
            if (StaffEngPrep.ProgressTracker.isModuleComplete('systemDesign', moduleNum)) {
                link.classList.add('completed');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const quizQuestions = [
                {
                    question: "What does CAP theorem state?",
                    options: [
                        "You can have all three: Consistency, Availability, Partition tolerance",
                        "You can only have two of: Consistency, Availability, Partition tolerance",
                        "Consistency always beats Availability",
                        "Partitions never happen in modern systems"
                    ],
                    correct: 1,
                    explanation: "CAP theorem states that in the presence of network partitions, you must choose between consistency and availability."
                },
                {
                    question: "What is the main benefit of consistent hashing?",
                    options: ["Faster lookups", "Minimal remapping on node changes", "Better security", "Simpler implementation"],
                    correct: 1,
                    explanation: "Consistent hashing minimizes the amount of data that needs to be remapped when nodes are added or removed."
                }
            ];
            const quiz = new StaffEngPrep.Quiz('module-quiz', quizQuestions);
            quiz.render();
        });
        function completeModule() {
            StaffEngPrep.ProgressTracker.markModuleComplete('systemDesign', 3);
            alert('Module 3 marked as complete!');
            window.location.href = 'module-04.html';
        }

        // ============================================
        // Interactive CAP Theorem Demo
        // ============================================
        const capScenarios = {
            cp: {
                title: 'CP Systems (Consistency + Partition Tolerance)',
                description: 'During a network partition, the system may reject requests to maintain consistency. Example: A bank refusing transactions during network issues rather than risking inconsistent balances.',
                examples: ['MongoDB', 'HBase', 'Redis Cluster', 'ZooKeeper'],
                nodes: ['consistency', 'partition'],
                edge: 'cp'
            },
            ap: {
                title: 'AP Systems (Availability + Partition Tolerance)',
                description: 'During a network partition, the system remains available but may return stale data. Example: A social media feed showing slightly outdated posts during network issues.',
                examples: ['Cassandra', 'DynamoDB', 'CouchDB', 'Riak'],
                nodes: ['availability', 'partition'],
                edge: 'ap'
            },
            ca: {
                title: 'CA Systems (Consistency + Availability)',
                description: 'Only possible in a single-node system or when there are no network partitions. Traditional RDBMS fits here, but in practice, partition tolerance is required for distributed systems.',
                examples: ['PostgreSQL (single)', 'MySQL (single)', 'Traditional RDBMS'],
                nodes: ['consistency', 'availability'],
                edge: 'ca'
            }
        };

        function showCapScenario(type) {
            const scenario = capScenarios[type];
            const capC = document.getElementById('cap-c');
            const capA = document.getElementById('cap-a');
            const capP = document.getElementById('cap-p');
            const edgeCA = document.getElementById('edge-ca');
            const edgeCP = document.getElementById('edge-cp');
            const edgeAP = document.getElementById('edge-ap');
            const explanation = document.getElementById('cap-explanation');

            // Reset all
            [capC, capA, capP].forEach(n => {
                n.classList.remove('selected', 'dimmed');
            });
            [edgeCA, edgeCP, edgeAP].forEach(e => {
                e.classList.remove('highlighted');
            });
            document.querySelectorAll('.cap-scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Highlight selected
            const nodeMap = { consistency: capC, availability: capA, partition: capP };
            const edgeMap = { ca: edgeCA, cp: edgeCP, ap: edgeAP };

            scenario.nodes.forEach(n => nodeMap[n].classList.add('selected'));
            edgeMap[scenario.edge].classList.add('highlighted');

            // Dim the unselected node
            ['consistency', 'availability', 'partition'].forEach(n => {
                if (!scenario.nodes.includes(n)) {
                    nodeMap[n].classList.add('dimmed');
                }
            });

            // Highlight button
            document.querySelector(`.cap-scenario-btn.${type}`).classList.add('active');

            // Update explanation
            explanation.innerHTML = `
                <h4>${scenario.title}</h4>
                <p>${scenario.description}</p>
                <div class="cap-examples">
                    ${scenario.examples.map(ex => `<span class="cap-example-tag">${ex}</span>`).join('')}
                </div>
            `;
        }

        // ============================================
        // Network Partition Demo
        // ============================================
        function setPartitionState(state) {
            const networkLine = document.getElementById('network-line');
            const zoneA = document.getElementById('zone-a');
            const zoneB = document.getElementById('zone-b');
            const server3 = document.getElementById('server-3');
            const server4 = document.getElementById('server-4');
            const server5 = document.getElementById('server-5');
            const status = document.getElementById('partition-status');

            if (state === 'partition') {
                networkLine.classList.add('broken');
                zoneA.classList.add('partitioned');
                zoneB.classList.add('partitioned');

                // Zone B has majority (3 nodes) - they elect new leader
                setTimeout(() => {
                    server3.className = 'server-node leader';
                    server3.innerHTML = '<span class="server-icon">üëë</span><span>New Leader</span>';

                    status.innerHTML = `
                        <strong style="color: #ff6b6b;">‚ö†Ô∏è Network Partition Detected!</strong><br><br>
                        <strong>Zone A (2 nodes):</strong> Old leader becomes unavailable - minority cannot serve writes (CP behavior)<br>
                        <strong>Zone B (3 nodes):</strong> New leader elected - majority can continue serving requests<br><br>
                        <em style="color: #a0aec0;">This is how Raft/Paxos handle partitions - the majority partition continues operating.</em>
                    `;
                }, 500);

            } else {
                networkLine.classList.remove('broken');
                zoneA.classList.remove('partitioned');
                zoneB.classList.remove('partitioned');

                server3.className = 'server-node follower';
                server3.innerHTML = '<span class="server-icon">üì°</span><span>Node 3</span>';

                status.innerHTML = '<strong>Status:</strong> All nodes communicating normally. Cluster is healthy with 5/5 nodes.';
            }
        }

        // ============================================
        // Interactive Raft Election Demo
        // ============================================
        let raftRunning = false;
        let raftInterval = null;
        let raftTerm = 0;
        let raftLeader = null;
        let raftNodes = [
            { id: 1, state: 'follower', votes: 0 },
            { id: 2, state: 'follower', votes: 0 },
            { id: 3, state: 'follower', votes: 0 },
            { id: 4, state: 'follower', votes: 0 },
            { id: 5, state: 'follower', votes: 0 }
        ];

        function addRaftLog(message, type = '') {
            const log = document.getElementById('raft-log');
            const entry = document.createElement('div');
            entry.className = `raft-log-entry ${type}`;
            entry.textContent = `[Term ${raftTerm}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;

            // Keep only last 20 entries
            while (log.children.length > 20) {
                log.removeChild(log.firstChild);
            }
        }

        function updateRaftUI() {
            raftNodes.forEach(node => {
                const el = document.getElementById(`raft-node-${node.id}`);
                el.className = `raft-node ${node.state}`;
                el.querySelector('.term').textContent = `Term: ${raftTerm}`;
                el.querySelector('.vote-count').textContent = node.votes;
            });
        }

        function startRaft() {
            raftRunning = true;
            document.getElementById('raft-start').disabled = true;
            document.getElementById('raft-stop').disabled = false;
            document.getElementById('raft-kill').disabled = false;
            document.getElementById('raft-log').innerHTML = '';

            addRaftLog('Cluster starting...', '');

            // Simulate election after timeout
            setTimeout(() => {
                if (!raftRunning) return;
                triggerElection();
            }, 1000);
        }

        function triggerElection() {
            if (!raftRunning) return;

            raftTerm++;
            const candidateId = raftLeader ?
                raftNodes.filter(n => n.id !== raftLeader).sort(() => Math.random() - 0.5)[0].id :
                Math.floor(Math.random() * 5) + 1;

            // Reset all nodes
            raftNodes.forEach(n => {
                n.state = 'follower';
                n.votes = 0;
            });

            const candidate = raftNodes.find(n => n.id === candidateId);
            candidate.state = 'candidate';
            candidate.votes = 1; // Vote for self
            updateRaftUI();

            addRaftLog(`Node ${candidateId} election timeout - becoming candidate`, 'election');
            addRaftLog(`Node ${candidateId} requests votes for term ${raftTerm}`, 'election');

            // Simulate vote collection
            let voteDelay = 300;
            raftNodes.forEach(node => {
                if (node.id !== candidateId && raftRunning) {
                    setTimeout(() => {
                        if (!raftRunning || candidate.state !== 'candidate') return;
                        candidate.votes++;
                        addRaftLog(`Node ${node.id} votes for Node ${candidateId}`, 'vote');
                        updateRaftUI();

                        // Check if won majority
                        if (candidate.votes >= 3 && candidate.state === 'candidate') {
                            candidate.state = 'leader';
                            raftLeader = candidateId;
                            addRaftLog(`Node ${candidateId} wins election with ${candidate.votes} votes!`, 'leader');
                            updateRaftUI();

                            // Start heartbeats
                            startHeartbeats(candidateId);
                        }
                    }, voteDelay);
                    voteDelay += 200;
                }
            });
        }

        function startHeartbeats(leaderId) {
            if (raftInterval) clearInterval(raftInterval);

            raftInterval = setInterval(() => {
                if (!raftRunning) return;
                addRaftLog(`Leader ${leaderId} sends heartbeat to followers`, 'heartbeat');
            }, 2000);
        }

        function killLeader() {
            if (!raftLeader || !raftRunning) return;

            const oldLeader = raftLeader;
            addRaftLog(`Node ${oldLeader} (leader) crashed!`, 'election');

            // Mark old leader as dead
            const leaderNode = raftNodes.find(n => n.id === oldLeader);
            leaderNode.state = 'follower';
            raftLeader = null;

            if (raftInterval) clearInterval(raftInterval);
            updateRaftUI();

            // Trigger new election after timeout
            setTimeout(() => {
                if (raftRunning) {
                    addRaftLog('Election timeout - starting new election', 'election');
                    triggerElection();
                }
            }, 1500);
        }

        function stopRaft() {
            raftRunning = false;
            if (raftInterval) clearInterval(raftInterval);
            document.getElementById('raft-start').disabled = false;
            document.getElementById('raft-stop').disabled = true;
            document.getElementById('raft-kill').disabled = true;

            raftTerm = 0;
            raftLeader = null;
            raftNodes.forEach(n => {
                n.state = 'follower';
                n.votes = 0;
            });
            updateRaftUI();
            addRaftLog('Cluster stopped.', '');
        }
    </script>
</body>
</html>
